---
- name: Deploy searxng Service
  hosts: docker
  vars:
    service_name: searxng
    additional_directories:
      - config
    copy_directories:
      - { src: "config", dest: "config" }
    secret_files:
      - { template: "{{ config_dir }}/settings.yml.tpl", dest: "{{ config_dir }}/settings.yml" }

  tasks:
    - name: Clone repository
      include_tasks: ../../tasks/docker/clone-repo.yml

    - name: Prepare directories
      include_tasks: ../../tasks/docker/prepare-directories.yml
    
    - name: Copy compose files from repo
      copy:
        src: "{{ repo_dir }}/docker/{{ service_name }}/compose/"
        dest: "{{ compose_dir }}/"
        remote_src: yes
      notify: "{{ ['docker service'] }}"

    - name: Copy additional directories
      copy:
        src: "{{ repo_dir }}/docker/{{ service_name }}/{{ item.src }}/"
        dest: "{{ base_dir }}/{{ item.dest }}/"
        remote_src: yes
      loop: "{{ copy_directories | default([]) }}"
      when: copy_directories is defined
      notify: "{{ ['docker service'] }}"

    - name: process secrets
      shell: |
        op inject -i "{{ item.template }}" -o "{{ item.dest }}" -f
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ op_token }}"
      loop: "{{ secret_files }}"
      no_log: true

    - name: Change permissions of searxng/settings.yml
      ansible.builtin.file:
        path: "{{ config_dir }}/settings.yml"
        mode: "0644"

    - name: Deploy/update and restart docker container
      community.docker.docker_compose_v2:
        project_src: "{{ compose_dir }}"
        files:
          - docker-compose.yml
        state: present
        pull: policy
        recreate: always

    - name: Uncomment cap_drop in docker-compose.yml
      ansible.builtin.replace:
        path: "{{ compose_dir }}/docker-compose.yml"
        regexp: '^(\s*)#(\s*)cap_drop:'
        replace: '\1\2cap_drop:'

    - name: Uncomment - ALL in docker-compose.yml
      ansible.builtin.replace:
        path: "{{ compose_dir }}/docker-compose.yml"
        regexp: '^(\s*)#(\s*)- ALL'
        replace: '\1\2- ALL'

    - name: Cleanup repository
      include_tasks: ../../tasks/docker/cleanup-repo.yml

  handlers:
    - import_tasks: ../../handlers/docker/docker-service.yml